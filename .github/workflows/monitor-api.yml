name: monitor API health
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: GET health check
        id: health_check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://llm-resume-restless-thunder-9259.fly.dev/health)
          echo "status_code=$response" >> $GITHUB_OUTPUT
          if [ "$response" != "200" ]; then
            echo "Health check failed with status $response"
            exit 1
          fi
      - name: Send WhatsApp alert
        if: always() && steps.health_check.outcome == 'failure'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC"
          curl -X POST \
            -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}" \
            https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json \
            --data-urlencode "From=${{ secrets.ACCOUNT_WHATSAPP_NUMBER }}" \
            --data-urlencode "To=${{ secrets.ALERT_WHATSAPP_NUMBER }}" \
            --data-urlencode "Body=Alert: API health check failed at $TIMESTAMP. Status: ${{ steps.health_check.outputs.status_code }}"
    